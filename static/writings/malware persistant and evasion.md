# Exploring Malware Persistence and Evasion Techniques

Delve into the intricate world of cybersecurity as we unravel the sophisticated strategies employed by malicious software to persist on compromised systems and evade detection. In this comprehensive blog, we shine a light on two critical aspects of malware functionality: Persistence and Evasion.

## Persistence

Malicious software often employs various techniques to maintain persistence on a compromised system, ensuring continuous operation or automatic restart after system reboots. These techniques make it challenging for security professionals to detect and remove malware. Common techniques used by _Emotet_ and other malwares include:

### 1. Run and RunOnce Keys (Windows)

- **Description:** Malware adds entries to the Windows Registry's "Run" and "RunOnce" keys for automatic execution at system startup or user logon.
- **Registry Paths to Inspect:**
  - `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
  - `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
  - `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
  - `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`

### 2. Services Keys (Windows)

- **Description:** Malware registers as a Windows service for automatic background execution.
- **Program to Inspect Services:**
  - Use the Windows Services Management Console or run `services.msc` to manage installed services.

### 3. Task Scheduler (Windows)

- **Description:** Malware creates scheduled tasks using the Windows Task Scheduler for timed or event-based persistence.
- **Program to Inspect Scheduled Tasks:**
  - Use the Windows Task Scheduler by running `taskschd.msc` to manage tasks.

### 4. Systemd Unit Files (Linux)

- **Description:** On Linux systems using systemd, malware manipulates unit files in `/etc/systemd/system/` and subdirectories for automatic execution at startup.

## Evasion Techniques

### 1. Evasion Obfuscation

**Obfuscation** is a technique used in computer science and cybersecurity to obscure code, data, or configurations for protection or malicious intent. Common obfuscation techniques include:

1. **Code Minification and Bundling:** Reduce web development code size by removing unnecessary spaces and comments.

2. **Renaming Variables and Functions:** Change variable and function names to arbitrary identifiers, hindering code understanding.

3. **Control Flow Obfuscation:** Rearrange code logic to make it less linear and more complex.

4. **String Encryption:** Encrypt strings in code to protect sensitive information.

5. **Code Splitting:** Load code dynamically at runtime for analysis resistance.

6. **Anti-Debugging Techniques:** Introduce measures to thwart reverse engineering attempts.

7. **Encoding and Decoding:** Represent data or code in different formats for complexity.

8. **Dead Code Insertion:** Add unused code to confuse analysts.

9. **Polymorphic Code:** Dynamically generate code at runtime for behavior unpredictability.

### 2. Evasion AntiSandbox

**Anti-sandbox evasion techniques** help malware avoid detection in sandbox environments. Techniques include:

1. **Checking for Virtualization Features:** Use CPUID instructions to detect virtualization features, indicating a sandbox.

2. **Monitoring Mouse and Keyboard Activity:** Observe user input to identify sandbox environments.

3. **Monitoring for Known VM Artifacts:** Look for files, directories, or registry entries associated with VMs.

### Actions After VM Detection:

1. **Delaying Malicious Actions:** Introduce time delays before executing malicious code.

2. **Changing Behavior:** Alter behavior or communication patterns.

3. **Sleep or Idle Loops:** Include loops to stall execution during sandbox analysis.

### 3. Evasion Polymorphic Code

**Polymorphic code** is used by malware authors to evade detection. Steps for generating polymorphic code:

1. **Compile Your Code to Assembly:** Convert code to assembly, serving as input for the engine.

2. **Read the Assembly Line Per Line or Block Per Block:** Separate assembly code into blocks or lines.

3. **Create Abstract Representation of Line or Block:** Generate a clean abstraction for comparison.

4. **Mapping the Abstractions to Their Equivalences:** Use a mapping to associate abstractions with equivalent assembly code snippets.

5. **Combining the Abstraction Mapping Results:** Generate polymorphic assembly code.

### 4. Evasion Process Hollowing

**Process hollowing** injects malicious code into a legitimate process's address space to evade detection. Steps for process hollowing:

1. **CreateProcess:** Start a new process using `CreateProcess` (e.g., `explorer.exe`).

2. **Allocate Memory:** Allocate memory within the new process's address space.

3. **Write Code:** Write malicious code into the allocated memory using `WriteProcessMemory`.

4. **Thread Creation:** Create a new thread in the target process to execute the injected code using `CreateRemoteThread`.
